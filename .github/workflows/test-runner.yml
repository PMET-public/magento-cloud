name: run tests & relase

on:
  push:
    branches:
      - master
      - pmet-2.4*

env:
  # set a default terminal for various cmds that expect it
  TERM: xterm
  COMPOSER_AUTH: ${{ secrets.COMPOSER_AUTH }}
  SLACK_WEBHOOK_URL_FOR_TMATE_FROM_GITHUB_WORKFLOW: ${{ secrets.SLACK_WEBHOOK_URL_FOR_TMATE_FROM_GITHUB_WORKFLOW }}
  TMATE_AUTHORIZED_KEYS_URL: ${{ secrets.TMATE_AUTHORIZED_KEYS_URL }}
  MDM_REPO_DIR: ${{ github.workspace}}/mdm

jobs:

  dockerize-then-run-magento-app:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os:
          - ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/checkout@v2
        with:
          repository: PMET-public/mdm
          submodules: true
          path: mdm
          ref: develop
      - name: bats tests
        run: |
          cd mdm
          ./tests/libs/bats/bin/bats -T ./tests/3-dockerize-then-run-magento-app/**/1-install-mdm-and-create-magento-app.bats
          cd ..
      - name: get updated, generated config.php
        if: ${{ success() }}
        run: |
          # be sure to create release.tar in default path
          app_dir="$(find "$HOME/Downloads" -maxdepth 1 -type d -name "*.app" || :)"
          "$app_dir/Contents/Resources/script" start_shell_in_app 'cat app/etc/config.php' > app/etc/config.php
          git archive --format=tar HEAD > release.tar
          tar -rf release.tar app/etc/config.php
      - if: ${{ success() }}
        run: |
          echo ::set-env name=RELEASE_TAG::"${GITHUB_REF#refs/heads/}-$(git rev-parse --short HEAD)"
      - if: ${{ success() }}
        uses: PMET-public/github-release@master
        with:
          tag: ${{ env.RELEASE_TAG }}
          token: ${{ secrets.GITHUB_TOKEN }}
          allow_override: true
          files: release.tar
          draft: false
          gzip: false
          prerelease: false
      - name: keep alive to debug
        if: ${{ failure() }}
        uses: PMET-public/action-tmate@master
